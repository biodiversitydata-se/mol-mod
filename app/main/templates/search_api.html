{% extends "layout.html" %}
{% block body %}

<div class='container'>
    <br>
    <form action='' method='post' id='sform' name='sform' class='search_function' >
        {{ sform.csrf_token }}
        <div class='row'>
            <div class='col-md-6'>
                <h6><b>Target gene(s)</b></h6>
                {{ sform.gene_sel(id='gene_sel', class='form-control') }}
            </div>
        </div>
        <br>
        <div class='row'>
            <div class='col-md-6'>
                <h6><b>Forward primer(s)</b></h6>
                {{ sform.fw_prim_sel(id='fw_prim_sel', class='form-control') }}
            </div>
            <div class='col-md-6'>
                <h6><b>Reverse primer(s)</b></h6>
                {{ sform.rv_prim_sel(id='rv_prim_sel', class='form-control') }}
            </div>
        </div>
        <br>
        <hr>
        <br>
        <div class='row'>
            <div class='col-md-2'>
                {{ sform.search_for_asv(class='btn btn-primary', id='search_for_asv') }}
            </div>
        </div>
    </form>
</div>
<br>
<br>
{% if rform %}
<div class='container' id='result'>
    <form action='http://molecular.infrabas.se/biocache-service/occurrences/batchSearch'
          method='post' id='rform' name='rform'>
        {{ rform.csrf_token }}
        <div class='row'>
            <div class='col-md-12'>
                <table id='result_table' class='dataframe table table-striped'>
                    <thead>
                        <tr>
                            <th>ASV</th>
                            <th>Target gene</th>
                            <th>Forward primer</th>
                            <th>Reverse primer</th>
                            <th><input type='checkbox' id='select_all' /></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i, row in rdf.iterrows() %}
                        <tr>
                            <td>{{ row['asv_id'] }}</td>
                            <td>{{ row['target_gene'] }}</td>
                            <td>{{ row['fw_prim'] }}</td>
                            <td>{{ row['rv_prim'] }}</td>
                            <td>{{ rform.asv_id(id=row['asv_id'], class='asv_id form-control') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>
        </div>
        <!-- Hidden part, for redirection to SBDI -->
        <div class='row'>
            <textarea name='queries' id='raw_names' style='display: none'></textarea>
            <!-- Make visible for testing: -->
            <!-- <textarea name='queries' id='raw_names' rows=4, cols=40></textarea> -->
            <input type='hidden' name='redirectBase'
                value='http://molecular.infrabas.se/ala-hub/occurrences/search'>
            <input type='hidden' name='field' value='raw_name'/>
            <input type='hidden' name='action' value='Search'/>
        </div>
        <br>
        <div class='row'>
            <div class='col-md-2'>
                <input id='show_occurrences' name='show_occurrences' type='submit' value='Show occurrences' class='btn btn-primary'/>
            </div>
            <div class='col-md-10 hiddenElem' id='selection_error'>Please select at least one BLAST hit</div>
        </div>
    </form>
</div>
{% endif %}

<script>
    $(document).ready(function () {
        // SEARCH FORM
        $.fn.select2.defaults.set("theme", "bootstrap");
        // Make select2-dropdowns for gene & primers
        var geneSelS2 = $('#gene_sel').select2({
            placeholder: 'Select target gene(s)'
        });
        var fwSelS2 = $('#fw_prim_sel').select2({
            placeholder: 'Select forward primer(s)'
        });
        var rvSelS2 = $('#rv_prim_sel').select2({
            placeholder: 'Select reverse primer(s)'
        });

        function filterPrimerOptions (dir) {
            // Get gene(s) to filter options on
            var gene = geneSelS2.val();
            if (dir === 'fw') { var primDrop = fwSelS2; }
            else { var primDrop = rvSelS2; }
            // If no selected gene, get all primers
            if (gene.length === 0) { gene = 'all'; }
            // Make Ajax request
            $.getJSON(
                // Set flask endpoint
                '/get_primers' + '/' + gene + '/' + dir,
                function(data) {
                    currSel = primDrop.val();
                    // Remove old options
                    primDrop.find('option').remove();
                    // Add option for each item in returned json object (data)
                    $.each(data, function(i,e) {
                        primDrop.append('<option value="' + e.name + '">' + e.display + '</option>');
                    });
                    primDrop.val(currSel);
                }
            );
        };
        // To 'keep' option filters after submit
        filterPrimerOptions('fw');
        filterPrimerOptions('rv');
        // Filter primer options when genes are selected
        geneSelS2.change(function () {
            filterPrimerOptions('fw');
            filterPrimerOptions('rv');
        });

        // RESULT FORM
        var sbdiArea = $('#raw_names');
        var hlpElem = $('#result_table tr > td:nth-child(5), #result_table tr>th:nth-child(5)');
        var hlpDiv = $('#selection_error');

        // Convert reasults to jQuery dataTable
        var dTb = $('#result_table').dataTable({
            // Modify layout of dataTable components:
            // l=Show.., f=Search, tr=table, i=Showing.., p=pagination
            dom: "<'row'<'col-md-4'l><'col-md-8'f>>" +
            "<'row'<'col-md-12't>>" +
            "<'row'<'col-md-3'B><'col-md-3'i><'col-md-6'p>>",
            stateSave: true,
            // Add download buttons
            buttons: [
                { extend: 'csv',
                    exportOptions: { rows: '.selectedRow'},
                    action: function ( e, dt, node, config ) {
                        // Warn & stop if no selection
                        if (dt.rows('.selectedRow').count() == 0) {
                            return alertNoSelection(hlpElem, hlpDiv);
                        }
                        $.fn.DataTable.ext.buttons.csvHtml5.action.call(this, e, dt, node, config);
                    }
                },
                { extend: 'excel',
                    exportOptions: { rows: '.selectedRow'},
                    action: function ( e, dt, node, config ) {
                        // Warn & stop if no selection
                        if (dt.rows('.selectedRow').count() == 0) {
                            return alertNoSelection(hlpElem, hlpDiv);
                        }
                        $.fn.DataTable.ext.buttons.excelHtml5.action.call(this, e, dt, node, config);
                    }
                }
            ],
            // Disable sort on select col - as it does not work
            'columnDefs': [
                { 'orderable': false, 'targets': 4 }
            ]
        });
        // Enable access to items in all pages
        var allPages = dTb.fnGetNodes();
        var asvBoxes = $('.asv_id', allPages);

        // When any ASV checkbox is changed
        asvBoxes.change(function () {
            // Toggle download selection
            $(this).closest('tr').toggleClass('selectedRow', this.checked);
            // Remove no-selection warnings (if any)
            if (this.checked) {
                hlpElem.removeClass('visHlpElem');
                hlpDiv.removeClass('visHlpDiv');
            }
        });

        // When header checkbox is changed
        $('#select_all').change(function () {
            // Toggle all ASV checkboxes
            asvBoxes.prop('checked', this.checked);
            // Toggle download selection
            asvBoxes.closest('tr').toggleClass('selectedRow', this.checked);
            // Remove no-selection warnings (if any)
            hlpElem.removeClass('visHlpElem');
            hlpDiv.removeClass('visHlpDiv');
        });

        // At SBDI submit
        $('#rform').submit(function() {
            // Copy ASV ids to hidden area
            addCheckedToArea(asvBoxes, sbdiArea);
            // Warn & stop if no selection
            if (!sbdiArea.val()) {
                return alertNoSelection(hlpElem, hlpDiv);
            }
        });

    });
</script>
{% endblock body %}
