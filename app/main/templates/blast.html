{% extends "layout.html" %}
{% block body %}
<div class="container">
    <form action="" method="post" id='sform' name="sform" class="search_function">
        {{ sform.csrf_token }}
        <div class="row">
            <div class="col-md-12">
                {% if sform.sequence.errors %}
                    <div class="form-group has-error">
                {% else %}
                    <div class="form-group">
                {% endif %}
                        <h5><b>Query sequence(s) </b>
                            <span id='sequence_count'>2108</span>/500000 characters</h5>
                        {{ sform.sequence(id='sequence_textarea', rows=8, cols=80, maxlength="500000", class='form-control') }}
                        <span id="helpBlock2" class="help-block">
                            {% for error in sform.sequence.errors %}
                            {{ error }}
                            {% endfor %}
                        </span>
                    </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <h5><b>Minimum identity (%)</b></h5>
                {% if sform.min_identity.errors %}
                    <div class="form-group has-error">
                {% else %}
                    <div class="form-group">
                {% endif %}
                        {{ sform.min_identity(id="min_identity_input", class="form-control", type="number") }}
                        <span class="help-block">
                            {% for error in sform.min_identity.errors %}
                            {{ error }}
                            {% endfor %}
                        </span>
                    </div>
            </div>
            <div class="col-md-3">
                <h5><b>Minimum query coverage (%)</b></h5>
                {% if sform.min_qry_cover.errors %}
                    <div class="form-group has-error">
                {% else %}
                    <div class="form-group">
                {% endif %}
                        {{ sform.min_qry_cover(id="min_qry_cover", class="form-control", type="number") }}
                        <span class="help-block">
                            {% for error in sform.min_qry_cover.errors %}
                            {{ error }}
                            {% endfor %}
                        </span>
                    </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                {{ sform.blast_for_seq(class='btn btn-primary', id='blast_for_seq') }}
            </div>
        </div>
    </form>
</div>
<br>
<br>

{% if rform %}
<div class="container" id="result">
    <form action="" method="post" id='rform' name="rform">
        {{ rform.csrf_token }}
        <div class="row">
            <div class="col-md-12">
                <table id='result_table' class="dataframe table table-striped">
                    <thead>
                        <tr>
                            <th>Query</th>
                            <th>Subject</th>
                            <th>Id (%)</th>
                            <th>Cov (%)</th>
                            <th>E-value</th>
                            <th><input type="checkbox" id="select_all" /></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i, row in rdf.iterrows() %}
                        <tr>
                            <td>{{ row['qacc'] }}</td>
                            {% autoescape false %}
                            <td>{{ row['sacc'] | replace(':', ':<br>') }}</td>
                            {% endautoescape %}
                            <td>{{ row['pident'] }}</td>
                            <td>{{ row['qcovhsp'] }}</td>
                            <td>{{ row['evalue'] }}</td>
                            <td>{{ rform.asvid(id=row['asvid'], class='asvid') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>
        </div>
        <!-- For redirection to SBDI -->
        <div class="row">
            <textarea name="queries" id="raw_names" style="display: none"></textarea>
            <!-- Visible for testing: -->
            <!-- <textarea name="queries" id="raw_names" rows=4, cols=40></textarea> -->
            <input type="hidden" name="redirectBase"
                value="http://molecular.infrabas.se/ala-hub/occurrences/search">
            <input type="hidden" name="field" value="raw_name"/>
            <input type="hidden" name="action" value="Search"/>
        </div>
        <br>
        <div class="row">
            <div class="col-md-2">
                <input id='download' name='download' type="submit" value="Download" class="btn btn-primary"/>
            </div>
            <div class="col-md-2">
                <input id='show_occurrences' name='show_occurrences' type="submit" value="Show occurrences" class="btn btn-primary"/>
            </div>
            <div class="col-md-8 help-block" style="display:none" id="asv_error">Please select at least one BLAST hit</div>
        </div>
    </form>
</div>
{% endif %}

<script type=text/javascript>
$(document).ready(function () {
    // Get input seq length
    $("#sequence_textarea").bind('input', function(){
        $("#sequence_count").text($(this).val().length);
    });

    // For pagination etc.
    // Convert BLAST result table to jQuery dataTable
    var dTb = $('#result_table').dataTable({
        // Modify layout: l=Show.., f=Search, tr=table, i=Showing.., p=pagination
        dom: "<'row'<'col-md-4'l><'col-md-8'f>>" +
        "<'row'<'col-md-12't>>" +
        "<'row'<'col-md-4'B><'col-md-4'i><'col-md-4'p>>",
        stateSave: true,
        buttons: [
            { extend: 'csv',
                exportOptions: { rows: '.checkedrow'},
                action: function ( e, dt, node, config ) {
                    if (!$("#raw_names").val()) {
                        return requireSelection();
                    }
                    $.fn.DataTable.ext.buttons.csvHtml5.action.call(this, e, dt, node, config);
                }
            },
            { extend: 'excel',
                exportOptions: { rows: '.checkedrow'},
                action: function ( e, dt, node, config ) {
                    if (!$("#raw_names").val()) {
                        return requireSelection();
                    }
                    $.fn.DataTable.ext.buttons.excelHtml5.action.call(this, e, dt, node, config);
                }
            },

            // className: 'btn btn-primary' to change style
        ],
        // searching: false,
        // Disable sort on select col - currently not working
        "columnDefs": [
            { "orderable": false, "targets": 5 }
        ]
    });

    // To access items in all pages...
    var allPages = dTb.fnGetNodes();

    // Add checked to hidden textarea for POST to SBDI
    // and add class for download filter
    function addChecked() {

        var ids = [];
        $(".asvid", allPages).map(function () {
            $(this).closest("tr").removeClass("checkedrow");
        });

        //For all checked
        $(".asvid:checkbox:checked", allPages).map(function () {
            // Add to list
            ids.push(this.id);
            // Add class for datatables download
            $(this).closest("tr").addClass("checkedrow");
        });
        //Remove duplicates
        ids = ids.filter(function(item, i, ids) {
            return i == ids.indexOf(item);
        });
        //Add to textarea
        $("#raw_names").val(ids.join("\n"));
    }
    // Apply addition when any ASV:s are checked
    $(".asvid", allPages).change(function () {
        // alert (this.check)
        addChecked();
    });
    // ... and when all are checked
    $("#select_all").change(function () {
        $(".asvid", allPages).prop('checked',this.checked);
        addChecked();
    });


    function requireSelection() {
        if (!$("#raw_names").val()) {
            //Highlight checkbox column
            $('#result_table tr > td:nth-child(6), #result_table tr>th:nth-child(6)').attr('bgcolor', '#f2e4e4');
            $('#asv_error').attr('style', 'text-align:right; color:#aa4442');
            return false;
        }
    }

    //Require at least one checked hit for SBDI submission
    $('#rform').submit(function() {
        return requireSelection();
    });

    //Change form action depending on submit button
    $('#download').click(function(){
        $('#rform').attr('action', '');
    });
    $('#show_occurrences').click(function(){
        $('#rform').attr('action', 'http://molecular.infrabas.se/biocache-service/occurrences/batchSearch');
    });

});
</script>
{% endblock body %}
